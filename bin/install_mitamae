#! /bin/bash

DESTDIR=${DESTDIR:-${HOME}}

uname_m=`uname -m | tr A-Z a-z`
uname_s=`uname -s | tr A-Z a-z`

case ${uname_m}-${uname_s} in
  arm64-darwin)
    uname_m=aarch64
    ;;
esac

mitamae_version=1.12.4
mitamae_platform=${uname_m}-${uname_s}
mitamae_url=https://github.com/k0kubun/mitamae/releases/download/v${mitamae_version}/mitamae-${mitamae_platform}

case "${uname_s}" in
darwin)
  case "${uname_m}" in
  aarch64)
    mitamae_sha256=3f59d8b27227059aa65c142e93dab17abac2db929ac9912a8693422417477113
    ;;
  x86_64)
    mitamae_sha256=03c27e47034c9a66c78381cf7d4f7e5b66869b51d806c2c5fd6e4df0e8756e4d
    ;;
  esac
  ;;

linux)
  mitamae_sha256=fd881910b1f2882a51544756b1751ac2867751097b3f10bf12af9ed5637d8e66
  ;;
esac

mitamae=${DESTDIR}/bin/mitamae

## Check sha255

if [ -f "${mitamae}" ]; then
  case "${uname_s}" in
  darwin)
    actual_sha256=`shasum -a 256 ${mitamae} | cut -d' ' -f1`
    ;;
  linux)
    actual_sha256=`sha256sum ${mitamae} | cut -d' ' -f1`
    ;;
  esac
  if [ "${mitamae_sha256}" != "${actual_sha256}" ]; then
    rm -f ${mitamae}
  fi
fi

## Download

if [ ! -x "${mitamae}" ]; then
  mkdir -p $(dirname ${mitamae})
  curl -fsSL -o ${mitamae} ${mitamae_url}
  chmod 755 ${mitamae}
fi
