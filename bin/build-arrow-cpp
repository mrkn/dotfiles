#!/bin/bash

function is_darwin() {
  case $(uname -s) in
    Darwin)
      return 0
      ;;
  esac
  return 1
}

function is_windows() {
  # TODO
  return 1
}

function expand_path() {
  local d="$1"
  case "$d" in
    /*)
      echo "$d"
      ;;
    *)
      echo $(pwd)/$d
      ;;
  esac
}

function init_env() {
  export ARROW_HOME=$PREFIX
  export ARROW_BUILD_TESTS=ON
  export CMAKE_EXPORT_COMPILE_COMMANDS=ON

  if is_darwin; then
    export OPENSSL_ROOT_DIR=$(brew --prefix openssl@1.1)
    export ARROW_JEMALLOC=ON
    export ARROW_ORC=ON
    export ARROW_FLIGHT=ON
    export ARROW_GANDIVA=ON
    export ARROW_PARQUET=ON
    export ARROW_WITH_ZLIB=ON
    export ARROW_WITH_LZ4=ON
    export ARROW_WITH_BZ2=ON
    export ARROW_WITH_ZSTD=ON
    export ARROW_WITH_SNAPPY=ON
    export ARROW_WITH_BROTLI=ON
  elif is_windows; then
    export CMAKE_ARGS="-A x64"
    export CMAKE_GENERATOR="Visual Studio 16 2019"
    export CMAKE_INSTALL_LIBDIR=bin
    export CMAKE_INSTALL_PREFIX=$PREFIX
    export ARROW_FLIGHT=OFF
    export ARROW_PARQUET=OFF
    export ARROW_WITH_ZLIB=OFF
    export ARROW_WITH_LZ4=OFF
    export ARROW_WITH_BZ2=OFF
    export ARROW_WITH_ZSTD=OFF
    export ARROW_WITH_SNAPPY=OFF
    export ARROW_WITH_BROTLI=OFF
    export ARROW_USE_GLOG=OFF
    export ARROW_BUILD_SHARED=ON
    export ARROW_BUILD_STATIC=OFF
    export ARROW_BOOST_USE_SHARED=OFF
    export ARROW_VERBOSE_THIRDPARTY_BUILD=OFF
    export BOOST_SOURCE=BUNDLED
  else # Assume ubuntu 18.04
    export ARROW_DEPENDENCY_SOURCE=SYSTEM
    export ARROW_FLIGHT=OFF
    export ARROW_GANDIVA=ON
    export ARROW_HDFS=ON
    export ARROW_INSTALL_NAME_RPATH=OFF
    export ARROW_NO_DEPRECATED_API=ON
    export ARROW_ORC=ON
    export ARROW_PARQUET=ON
    export ARROW_PLASMA=ON
    export ARROW_USE_ASAN=OFF
    export ARROW_USE_CCACHE=ON
    export ARROW_USE_UBSAN=OFF
    export ARROW_WITH_BROTLI=ON
    export ARROW_WITH_BZ2=ON
    export ARROW_WITH_LZ4=ON
    export ARROW_WITH_SNAPPY=ON
    export ARROW_WITH_ZLIB=ON
    export ARROW_WITH_ZSTD=ON
    export GTest_SOURCE=BUNDLED
    export ORC_SOURCE=BUNDLED
    export PARQUET_BUILD_EXECUTABLE=ON
    export PARQUET_BUILD_EXAMPLES=ON
    export Thrift_SOURCE=BUNDLED
  fi
}

function run_cmake() {
  if is_darwin; then
    export OPENSSL_ROOT_DIR=$(brew --prefix openssl)
    #export BOOST_ROOT=$(brew --prefix boost)
    ARROW_BOOST_VENDORED=ON
    export LLVM_DIR=$(brew --prefix llvm@7)
    export CLANG_TOOLS_PATH=$(brew --prefix llvm@7)/bin
    #export gRPC_ROOT=$(brew --prefix grpc)
    ARROW_GRPC_VENDORED=ON
    export THRIFT_ROOT=$(brew --prefix thrift)
    PYTHON=$(which ${PYTHON:-$(brew --prefix python3)/bin/python3})
    ARROW_FLIGHT=ON
  fi

  if [ ! -d ${ARROW_CPP_BUILD_DIR} ]; then
    mkdir -p ${ARROW_CPP_BUILD_DIR}
  fi

  if [ "$CLANG" == 1 ]; then
    if is_darwin; then
      export PATH=$CLANG_TOOLS_PATH:$PATH
      CC=clang
      CXX=clang++
    else
      CC=clang-7
      CXX=clang++-7
    fi
  fi

  if [ "$GCC" == 1 ]; then
    CC=gcc
    CXX=g++
  fi

  pushd ${ARROW_CPP_BUILD_DIR}
  cmake ${LOGLEVEL:+--log-level=${LOGLEVEL}} \
        -DARROW_BUILD_EXAMPLES=ON \
        -DARROW_BUILD_TESTS=ON \
        -DARROW_BUILD_UTILITIES=ON \
        -DARROW_DEPENDENCY_SOURCE=SYSTEM \
        -DARROW_DATASET=ON \
        -DARROW_FLIGHT=${ARROW_FLIGHT:-OFF} \
        -DARROW_GANDIVA=ON \
        -DARROW_HDFS=ON \
        -DARROW_HOME=$PREFIX \
        -DARROW_INSTALL_NAME_RPATH=OFF \
        -DARROW_JEMALLOC=ON \
        -DARROW_NO_DEPRECATED_API=ON \
        -DARROW_OPTIONAL_INSTALL=ON \
        -DARROW_ORC=OFF \
        -DARROW_PARQUET=ON \
        -DARROW_PLASMA=ON \
        -DARROW_USE_ASAN=OFF \
        -DARROW_USE_CCACHE=${ARROW_USE_CCACHE:-ON} \
        -DARROW_USE_UBSAN=OFF \
        -DARROW_WITH_BROTLI=ON \
        -DARROW_WITH_BZ2=ON \
        -DARROW_WITH_LZ4=ON \
        -DARROW_WITH_SNAPPY=ON \
        -DARROW_WITH_ZLIB=ON \
        -DARROW_WITH_ZSTD=ON \
        -DARROW_FUZZING=${ARROW_FUZZING:-OFF} \
        ${ARROW_GENERATE_COVERAGE:+-DARROW_GENERATE_COVERAGE=${ARROW_GENERATE_COVERAGE}} \
        -DARROW_BOOST_VENDORED=${ARROW_BOOST_VENDORED:-OFF} \
        -DARROW_GRPC_VENDORED=${ARROW_GRPC_VENDORED:-OFF} \
        -DARROW_EXTRA_ERROR_CONTEXT=ON \
        -DARROW_PYTHON=ON \
        -DBUILD_WARNING_LEVEL=CHECKIN \
        -DCMAKE_BUILD_TYPE=${ARROW_BUILD_TYPE:-debug} \
        -DCMAKE_C_FLAGS=${CFLAGS:-} \
        -DCMAKE_CXX_FLAGS=${CXXFLAGS:-} \
        -DCMAKE_EXPORT_COMPILE_COMMANDS=${CMAKE_EXPORT_COMPILE_COMMANDS:-OFF} \
        -DCMAKE_INSTALL_PREFIX=$PREFIX \
        -DGTest_SOURCE=BUNDLED \
        -DORC_SOURCE=BUNDLED \
        -DThrift_SOURCE=BUNDLED \
        -DPARQUET_BUILD_EXAMPLES=ON \
        -DPARQUET_BUILD_EXECUTABLES=ON \
        -DPYTHON_EXECUTABLE=${PYTHON:-$(which python3)} \
        -GNinja \
        ${ARROW_CPP_ROOT}
        # -DARROW_GFLAGS_USE_SHARED=OFF \
  popd
}

function run_build() {
  # export OPENSSL_ROOT_DIR=$(brew --prefix openssl)
  ninja -C ${ARROW_CPP_BUILD_DIR} -j ${BUILD_JOBS:-6}
}

function run_install() {
  # OPENSSL_ROOT_DIR=$(brew --prefix openssl)
  ninja -C ${ARROW_CPP_BUILD_DIR} install
}

function help() {
  cat <<HELP
Usage: $0 [OPTIONS] [BUILD_DIR]

Build Arrow C++ library on the build directory specified by BUILD_DIR.
The default build directory is "./build".

OPTIONS:

  --help       Show this message
  --cmake      Run cmake to configure the build environment
  --clang      Use clang
  --gcc        Use gcc
  --coverage   Enable coverage (imply clang)
  --fuzzing    Enable fuzzing (imply coverage and clang)
  --install    Run ninja install
  --no-ccache  Stop using ccache
  --prefix     Specify the prefix directory to install
  --release    Release build (the default is debug build)

HELP
}

ARGS=()
RUN_CMAKE=0
RUN_INSTALL=0
PREFIX=/opt/arrow-dev
BUILD_JOBS=6
ARROW_CPP_ROOT=$(pwd)
ARROW_CPP_BUILD_DIR=${ARROW_CPP_ROOT}/build
ARROW_BUILD_TYPE=debug
ARROW_USE_CCACHE=ON
while [[ $# -gt 0 ]]; do
  case "$1" in
    --help)
      help
      exit
      ;;
    --cmake)
      RUN_CMAKE=1
      ;;
    --clang)
      CLANG=1
      ;;
    --gcc)
      GCC=1
      ;;
    --coverage)
      ARROW_GENERATE_COVERAGE=ON
      ;;
    --fuzzing)
      ARROW_FUZZING=ON
      ;;
    --install)
      RUN_INSTALL=1
      ;;
    --no-ccache)
      ARROW_USE_CCACHE=OFF
      ;;
    --prefix)
      shift
      PREFIX="$1"
      ;;
    --release)
      ARROW_BUILD_TYPE=release
      ;;
    --verbose)
      LOGLEVEL=VERBOSE
      ;;
    *)
      ARGS+=("$1")
      ;;
  esac
  shift
done

if [ -n "${ARGS[0]}" ]; then
  ARROW_CPP_BUILD_DIR=$(expand_path "${ARGS[0]}")
  if [ ! -d $ARROW_CPP_BUILD_DIR ]; then
    mkdir -p $ARROW_CPP_BUILD_DIR
  fi
fi

if [ "$ARROW_FUZZING" == "ON" ]; then
  ARROW_GENERATE_COVERAGE=ON
fi

if [ "$ARROW_GENERATE_COVERAGE" == "ON" ]; then
  CLANG=1
  GCC=0
fi

if [ -z "$GCC" -a -z "$CLANG" ]; then
  : do nothing
elif [ "$GCC" == 1 -a -z "$CLANG" == 1 ]; then
  echo "--gcc and --clang cannot be specified at the same time" 1>&2
  exit 1
fi

set -ex

if [ "$RUN_CMAKE" == 1 ]; then
  run_cmake
fi

run_build

if [ "$RUN_INSTALL" == 1 ]; then
  run_install
fi
